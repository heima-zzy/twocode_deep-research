# 第一阶段：基础设施搭建

## 概述

本阶段将为整个二次开发项目搭建必要的基础设施，包括数据库系统、向量数据库、消息队列和基础 API 架构扩展。预计耗时 1-2 周。

## 任务分解

### 1. 数据库设计与初始化

#### 1.1 PostgreSQL 数据库搭建

**任务描述**：
- 安装和配置 PostgreSQL 数据库
- 设计数据库表结构
- 集成 Prisma ORM
- 创建数据库迁移文件

**实施步骤**：
1. 在项目根目录创建 `docker-compose.dev.yml` 文件，添加 PostgreSQL 服务配置
2. 安装 Prisma 相关依赖包
3. 初始化 Prisma 配置文件
4. 设计并创建 `schema.prisma` 文件，定义所有数据表结构
5. 生成并执行数据库迁移
6. 创建数据库连接工具类

**核心表结构设计**：
- `users` - 用户信息表（id, username, email, password_hash, role, created_at, updated_at）
- `crawler_configs` - 爬虫配置表（id, name, target_url, rules, schedule, status, user_id）
- `crawler_tasks` - 爬虫任务表（id, config_id, status, start_time, end_time, result_count）
- `raw_data` - 原始数据表（id, task_id, url, title, content, metadata, created_at）
- `processed_data` - 处理后数据表（id, raw_data_id, cleaned_content, keywords, category）
- `vector_embeddings` - 向量嵌入表（id, data_id, vector, model_name, created_at）
- `search_tasks` - 搜索任务表（id, query, user_id, results, created_at）
- `qa_sessions` - 问答会话表（id, user_id, question, answer, sources, created_at）
- `system_logs` - 系统日志表（id, level, message, module, created_at）

**测试方法**：
1. **数据库连接测试**：创建一个测试脚本，验证数据库连接是否正常
2. **表结构验证**：编写单元测试，验证所有表是否正确创建
3. **CRUD 操作测试**：为每个表编写基础的增删改查测试
4. **迁移测试**：测试数据库迁移的正向和回滚操作

#### 1.2 Prisma ORM 集成

**任务描述**：
- 配置 Prisma 客户端
- 创建数据访问层（DAL）
- 实现基础的 CRUD 操作

**实施步骤**：
1. 创建 `src/lib/prisma.ts` 文件，配置 Prisma 客户端
2. 在 `src/lib/db/` 目录下创建各个表的数据访问类
3. 实现通用的数据库操作方法
4. 创建数据库种子文件，用于初始化测试数据

**测试方法**：
1. **单元测试**：为每个数据访问类编写单元测试文件
2. **集成测试**：测试 Prisma 客户端与数据库的集成
3. **性能测试**：测试数据库查询性能，确保响应时间在可接受范围内

### 2. 向量数据库集成

#### 2.1 Qdrant 向量数据库搭建

**任务描述**：
- 部署 Qdrant 向量数据库
- 配置向量集合（Collection）
- 实现向量存储和检索接口

**实施步骤**：
1. 在 `docker-compose.dev.yml` 中添加 Qdrant 服务配置
2. 安装 Qdrant 客户端 SDK
3. 创建 `src/lib/vector/qdrant.ts` 文件，封装 Qdrant 操作
4. 设计向量集合结构，支持多种嵌入模型
5. 实现向量的增删改查操作
6. 创建向量相似度搜索接口

**向量集合设计**：
- 集合名称：`documents`
- 向量维度：1536（OpenAI text-embedding-ada-002）或其他模型维度
- 距离度量：余弦相似度
- 负载字段：document_id, content, metadata, timestamp

**测试方法**：
1. **连接测试**：验证 Qdrant 服务是否正常启动和连接
2. **向量操作测试**：测试向量的插入、更新、删除操作
3. **相似度搜索测试**：使用已知向量进行相似度搜索，验证结果准确性
4. **性能测试**：测试大量向量的存储和检索性能

#### 2.2 向量嵌入服务

**任务描述**：
- 集成文本嵌入模型
- 实现文本向量化接口
- 支持多种嵌入模型切换

**实施步骤**：
1. 创建 `src/lib/embeddings/` 目录
2. 实现 OpenAI Embeddings API 集成
3. 实现本地嵌入模型支持（可选）
4. 创建嵌入服务的统一接口
5. 实现批量文本向量化功能

**测试方法**：
1. **嵌入测试**：测试文本转换为向量的功能
2. **批量处理测试**：测试大量文本的批量向量化
3. **模型切换测试**：验证不同嵌入模型之间的切换
4. **API 测试**：使用 Postman 测试嵌入 API 接口

### 3. 消息队列系统搭建

#### 3.1 Redis 和 Bull Queue 集成

**任务描述**：
- 部署 Redis 服务
- 集成 Bull Queue 任务队列
- 实现任务调度和处理机制

**实施步骤**：
1. 在 `docker-compose.dev.yml` 中添加 Redis 服务
2. 安装 Bull Queue 相关依赖
3. 创建 `src/lib/queue/` 目录
4. 实现队列管理器和任务处理器
5. 创建不同类型的任务队列（爬虫、数据处理、向量化等）
6. 实现任务监控和重试机制

**队列类型设计**：
- `crawler-queue`：爬虫任务队列
- `processing-queue`：数据处理队列
- `embedding-queue`：向量化任务队列
- `notification-queue`：通知任务队列

**测试方法**：
1. **Redis 连接测试**：验证 Redis 服务连接
2. **队列操作测试**：测试任务的添加、处理、完成状态
3. **并发处理测试**：测试多个任务的并发处理能力
4. **重试机制测试**：测试失败任务的重试功能
5. **监控测试**：验证任务监控和状态追踪功能

#### 3.2 任务调度器

**任务描述**：
- 实现定时任务调度
- 支持 Cron 表达式
- 实现任务优先级管理

**实施步骤**：
1. 创建 `src/lib/scheduler/` 目录
2. 实现基于 Bull Queue 的定时任务调度器
3. 支持 Cron 表达式解析
4. 实现任务优先级队列
5. 创建任务调度的管理接口

**测试方法**：
1. **定时任务测试**：验证定时任务是否按时执行
2. **Cron 表达式测试**：测试各种 Cron 表达式的解析和执行
3. **优先级测试**：验证高优先级任务优先执行
4. **调度管理测试**：测试任务的启动、停止、修改功能

### 4. 基础 API 架构扩展

#### 4.1 API 路由结构设计

**任务描述**：
- 扩展现有 API 路由结构
- 实现统一的 API 响应格式
- 添加 API 版本控制

**实施步骤**：
1. 在 `src/app/api/` 下创建 `v1/` 目录
2. 设计统一的 API 响应格式
3. 创建 API 中间件（认证、日志、错误处理）
4. 实现基础的 CRUD API 模板
5. 添加 API 文档生成工具

**API 路由结构**：
```
/api/v1/
├── auth/          # 认证相关
├── users/         # 用户管理
├── crawler/       # 爬虫管理
├── data/          # 数据管理
├── search/        # 搜索功能
├── qa/            # 问答功能
└── system/        # 系统管理
```

**测试方法**：
1. **API 路由测试**：使用 Postman 测试所有 API 路由
2. **响应格式测试**：验证 API 响应格式的一致性
3. **版本控制测试**：测试不同版本 API 的兼容性
4. **中间件测试**：验证认证、日志、错误处理中间件

#### 4.2 认证和授权系统

**任务描述**：
- 实现 JWT 认证机制
- 设计角色权限系统
- 实现 API 访问控制

**实施步骤**：
1. 安装 JWT 相关依赖
2. 创建 `src/lib/auth/` 目录
3. 实现 JWT 生成和验证功能
4. 设计角色权限模型（管理员、普通用户）
5. 创建认证中间件
6. 实现登录、注册、密码重置功能

**权限设计**：
- `admin`：系统管理员，拥有所有权限
- `user`：普通用户，只能访问自己的数据
- `guest`：访客，只能查看公开数据

**测试方法**：
1. **认证测试**：测试登录、注册、密码重置功能
2. **JWT 测试**：验证 JWT 的生成、验证、过期处理
3. **权限测试**：测试不同角色的 API 访问权限
4. **安全测试**：测试常见的安全漏洞（SQL 注入、XSS 等）

## 环境配置

### 开发环境配置

**环境变量配置**：
在 `.env.local` 文件中添加以下配置：

```
# 数据库配置
DATABASE_URL="postgresql://username:password@localhost:5432/deep_research"

# Redis 配置
REDIS_URL="redis://localhost:6379"

# Qdrant 配置
QDRANT_URL="http://localhost:6333"

# JWT 配置
JWT_SECRET="your-jwt-secret"
JWT_EXPIRES_IN="7d"

# 嵌入模型配置
EMBEDDING_MODEL="text-embedding-ada-002"
EMBEDDING_DIMENSIONS=1536
```

### Docker 配置

**docker-compose.dev.yml 示例**：
```yaml
version: '3.8'
services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: deep_research
      POSTGRES_USER: username
      POSTGRES_PASSWORD: password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333"
    volumes:
      - qdrant_data:/qdrant/storage

volumes:
  postgres_data:
  redis_data:
  qdrant_data:
```

## 验收标准

### 功能验收
1. 数据库连接正常，所有表结构创建成功
2. Prisma ORM 集成完成，基础 CRUD 操作正常
3. Qdrant 向量数据库部署成功，向量操作正常
4. Redis 和 Bull Queue 集成完成，任务队列正常工作
5. 基础 API 架构搭建完成，认证授权系统正常

### 性能验收
1. 数据库查询响应时间 < 100ms（简单查询）
2. 向量相似度搜索响应时间 < 500ms（1000 个向量）
3. 任务队列处理能力 > 100 任务/分钟
4. API 接口响应时间 < 200ms

### 测试覆盖率
1. 单元测试覆盖率 > 80%
2. 集成测试覆盖所有核心功能
3. API 测试覆盖所有接口

## 常见问题和解决方案

### 数据库相关
1. **连接池配置**：合理配置 Prisma 连接池大小
2. **迁移冲突**：使用 Prisma 的迁移重置功能
3. **性能优化**：添加必要的数据库索引

### 向量数据库相关
1. **内存使用**：监控 Qdrant 内存使用情况
2. **向量维度**：确保向量维度与嵌入模型一致
3. **集合配置**：根据数据量调整集合参数

### 消息队列相关
1. **任务堆积**：监控队列长度，及时处理堆积任务
2. **内存泄漏**：正确关闭队列连接
3. **重试策略**：合理配置任务重试次数和间隔

## 下一阶段准备

完成本阶段后，需要为下一阶段（爬虫系统开发）做好准备：

1. 确认所有基础服务正常运行
2. 完成基础 API 的测试
3. 准备爬虫相关的依赖包安装
4. 设计爬虫任务的数据流程

本阶段的成功完成将为整个项目奠定坚实的技术基础。