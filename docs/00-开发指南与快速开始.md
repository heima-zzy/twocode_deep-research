# Deep Research 二次开发指南

## 项目概述

本项目基于现有的 Deep Research 项目进行二次开发，目标是创建一个集成AI对话和深度研究功能的综合性平台。新增的聊天首页提供类似 DeepSeek 的用户体验，同时完全保留原有的深度研究功能。

## 快速开始

### 环境要求

- Node.js 18.0 或更高版本
- npm 或 pnpm 包管理器
- 现代浏览器（Chrome 90+, Firefox 88+, Safari 14+）

### 安装依赖

```bash
# 使用 npm
npm install

# 或使用 pnpm（推荐）
pnpm install
```

### 环境配置

1. 复制环境变量文件：
```bash
cp env.local .env.local
```

2. 配置必要的API密钥：
   - 至少配置一个AI提供者（OpenAI、Anthropic、DeepSeek等）
   - 可选配置搜索服务提供者
   - 设置访问密码（如需要）

### 启动开发服务器

```bash
npm run dev
# 或
pnpm dev
```

访问 http://localhost:3000 查看应用。

## 开发流程

### 阶段性开发

本项目采用分阶段开发的方式，每个阶段都有明确的目标和测试标准：

1. **[阶段一：路由结构设计与页面架构](./02-阶段一：路由结构设计与页面架构.md)**
   - 重新设计路由结构
   - 创建聊天首页布局
   - 迁移深度研究功能到独立路由

2. **[阶段二：数据层扩展与AI对话集成](./03-阶段二：数据层扩展与AI对话集成.md)**
   - 扩展状态管理系统
   - 实现聊天数据模型
   - 集成AI对话功能

3. **[阶段三：UI组件开发与用户界面实现](./04-阶段三：UI组件开发与用户界面实现.md)**
   - 开发聊天界面组件
   - 实现左侧边栏功能
   - 优化响应式设计

4. **[阶段四：功能集成与系统优化](./05-阶段四：功能集成与系统优化.md)**
   - 实现页面间导航
   - 优化系统性能
   - 提升用户体验

5. **[阶段五：测试与部署验证](./06-阶段五：测试与部署验证.md)**
   - 全面功能测试
   - 部署验证
   - 生产环境监控

### 开发原则

1. **保持兼容性**：确保现有功能完全保留
2. **模块化设计**：新功能作为独立模块开发
3. **代码复用**：充分利用现有组件和工具
4. **测试驱动**：每个功能都要有对应的测试
5. **性能优先**：始终关注性能和用户体验

## 技术架构

### 技术栈

- **前端框架**：Next.js 14 (React 18)
- **状态管理**：Zustand
- **样式方案**：Tailwind CSS
- **UI组件**：Shadcn/ui
- **类型检查**：TypeScript
- **测试框架**：Jest + React Testing Library
- **部署平台**：Vercel / Docker

### 项目结构

```
src/
├── app/                    # Next.js App Router
│   ├── page.tsx           # 聊天首页
│   ├── research/          # 深度研究页面
│   └── api/               # API路由
├── components/            # React组件
│   ├── Chat/              # 聊天相关组件
│   ├── Research/          # 研究相关组件
│   └── ui/                # 基础UI组件
├── hooks/                 # 自定义Hooks
├── store/                 # 状态管理
├── utils/                 # 工具函数
└── types.d.ts            # 类型定义
```

### 核心概念

#### 状态管理
- **ChatStore**：管理聊天会话和消息
- **TaskStore**：管理深度研究任务
- **KnowledgeStore**：管理知识库
- **SettingStore**：管理用户设置
- **GlobalStore**：管理全局UI状态

#### 数据流
1. 用户在聊天界面输入消息
2. 消息通过ChatStore管理
3. AI提供者处理消息并返回回复
4. 回复以流式方式显示给用户
5. 对话历史持久化存储

#### 页面导航
- `/` - 聊天首页
- `/research` - 深度研究页面
- 页面间通过状态传递实现数据共享

## 开发指导

### 代码规范

1. **命名规范**：
   - 组件使用PascalCase
   - 函数和变量使用camelCase
   - 常量使用UPPER_SNAKE_CASE
   - 文件名使用kebab-case或PascalCase

2. **组件设计**：
   - 保持组件的单一职责
   - 使用TypeScript定义清晰的接口
   - 实现适当的错误边界
   - 添加必要的加载和错误状态

3. **性能优化**：
   - 使用React.memo避免不必要的重渲染
   - 合理使用useMemo和useCallback
   - 实现虚拟滚动处理大量数据
   - 使用代码分割和懒加载

### 测试策略

1. **单元测试**：
   - 测试所有组件的渲染和交互
   - 测试自定义Hook的功能
   - 测试工具函数的正确性

2. **集成测试**：
   - 测试组件间的交互
   - 测试API的集成
   - 测试状态管理的正确性

3. **端到端测试**：
   - 测试完整的用户流程
   - 验证跨浏览器兼容性
   - 测试响应式设计

### 调试技巧

1. **开发工具**：
   - 使用React Developer Tools
   - 利用Zustand DevTools
   - 使用浏览器的Network面板监控API调用

2. **日志记录**：
   - 在关键位置添加console.log
   - 使用条件日志避免生产环境输出
   - 记录错误和异常情况

3. **性能分析**：
   - 使用React Profiler分析渲染性能
   - 监控内存使用情况
   - 分析网络请求的性能

## 常见问题

### Q: 如何添加新的AI提供者？

A: 参考现有的AI提供者实现，在 `src/app/api/ai/` 目录下添加新的路由，并在 `src/utils/model.ts` 中注册新的提供者。

### Q: 如何自定义聊天界面的样式？

A: 修改 `src/components/Chat/` 目录下的组件样式，使用Tailwind CSS类或自定义CSS。

### Q: 如何集成新的知识库来源？

A: 在 `src/hooks/useKnowledge.ts` 中添加新的知识获取方法，并在知识库组件中添加相应的UI。

### Q: 如何优化大量历史记录的性能？

A: 实现虚拟滚动，参考 `src/components/Chat/VirtualList.tsx`（需要创建）的实现。

### Q: 如何处理AI API的错误？

A: 在 `src/hooks/useChat.ts` 中实现错误处理逻辑，包括重试机制和用户友好的错误提示。

## 部署指南

### 本地部署

```bash
# 构建生产版本
npm run build

# 启动生产服务器
npm start
```

### Docker部署

```bash
# 构建Docker镜像
docker build -t deep-research .

# 运行容器
docker run -p 3000:3000 deep-research
```

### Vercel部署

1. 连接GitHub仓库到Vercel
2. 配置环境变量
3. 自动部署

## 贡献指南

### 提交代码

1. Fork项目仓库
2. 创建功能分支
3. 编写代码和测试
4. 提交Pull Request

### 代码审查

- 确保代码符合项目规范
- 验证功能的正确性
- 检查测试覆盖率
- 评估性能影响

## 支持与反馈

- **技术问题**：查看项目文档或提交Issue
- **功能建议**：通过GitHub Discussions讨论
- **Bug报告**：使用Issue模板提交详细信息

## 许可证

本项目遵循原项目的开源许可证。请查看LICENSE文件了解详细信息。

---

**开始开发**：建议从阶段一开始，按照文档逐步完成每个阶段的开发任务。每完成一个阶段，都要进行充分的测试验证，确保功能稳定后再进入下一阶段。